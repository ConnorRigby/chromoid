PREFIX = $(MIX_APP_PATH)/priv
BUILD  = $(MIX_APP_PATH)/obj

LIBFREENECT_VERSION_MAJOR = 0.6
LIBFREENECT_VERSION = $(LIBFREENECT_VERSION_MAJOR).1
LIBFREENECT_SOURCE = libfreenect-$(LIBFREENECT_VERSION).tar.gz
LIBFREENECT_SITE = https://github.com/OpenKinect/libfreenect/archive/v$(LIBFREENECT_VERSION).tar.gz
LIBFREENECT = $(PREFIX)/lib/libfreenect.a
LIBFREENECT_BUILD = $(MIX_APP_PATH)/libfreenect-0.6.1
LIBFREENECT_CFLAGS += -I$(PREFIX)/include/libfreenect
LIBFREENECT_LDFLAGS += -L$(PREFIX)/lib -lfreenect
LIBFREENECT_CMAKE_FLAGS = -DBUILD_PYTHON=OFF -DBUILD_PYTHON3=OFF -DCMAKE_BUILD_TYPE=RelWithDebInfo #-DBUILD_EXAMPLES=OFF

LIBUSB_VERSION_MAJOR = 1.0
LIBUSB_VERSION = $(LIBUSB_VERSION_MAJOR).23
LIBUSB_SOURCE = libusb-$(LIBUSB_VERSION).tar.bz2
LIBUSB_SITE = https://github.com/libusb/libusb/releases/download/v$(LIBUSB_VERSION)
LIBUSB = $(PREFIX)/lib/libusb-1.0.a
LIBUSB_BUILD = $(MIX_APP_PATH)/libusb-1.0.23
LIBUSB_CFLAGS = -I$(PREFIX)/include/libusb-1.0
LIBUSB_LDFLAGS += -L$(PREFIX)/lib -lusb-1.0
LIBUSB_CONFIGURE_ARGS = --host=arm-linux

LIBJPEG_TURBO_VERSION_MAJOR = 2.0
LIBJPEG_TURBO_VERSION = $(LIBJPEG_TURBO_VERSION_MAJOR).5
LIBJPEG_TURBO_SOURCE = libjpeg-turbo-$(LIBJPEG_TURBO_VERSION).tar.gz
LIBJPEG_TURBO_SITE = https://netactuate.dl.sourceforge.net/project/libjpeg-turbo/$(LIBJPEG_TURBO_VERSION)/
ifeq ($(CROSSCOMPILE),)
LIBJPEG_TURBO = $(PREFIX)/lib64/libturbojpeg.a
else
LIBJPEG_TURBO = $(PREFIX)/lib/libturbojpeg.a
endif
LIBJPEG_TURBO_BUILD = $(MIX_APP_PATH)/libjpeg-turbo-$(LIBJPEG_TURBO_VERSION)
LIBJPEG_TURBO_CFLAGS =
LIBJPEG_TURBO_LDFLAGS += -L$(PREFIX)/lib -lturbojpeg

LDFLAGS += -lm 

SRC = $(wildcard src/*.c)
HEADERS = $(wildcard src/*.h)
OBJ = $(SRC:src/%.c=$(BUILD)/%.o)

PORT = $(PREFIX)/freenect_port

calling_from_make:
	mix compile

all: install

install: $(PREFIX) $(BUILD) $(PORT)

$(OBJ): $(HEADERS) Makefile

$(PORT): $(LIBUSB) $(LIBFREENECT) $(LIBJPEG_TURBO) $(OBJ)
	$(CC) -o $@ $(OBJ) $(LDFLAGS) -L$(PREFIX)/lib $(LIBUSB_LDFLAGS) $(LIBJPEG_TURBO_LDFLAGS) $(LIBFREENECT_LDFLAGS)

$(BUILD)/%.o: src/%.c
	$(CC) -c $(CFLAGS) -I$(PREFIX)/include $(LIBUSB_CFLAGS) $(LIBJPEG_TURBO_CFLAGS) $(LIBFREENECT_CFLAGS) -o $@ $<

$(LIBUSB): $(MIX_APP_PATH)/$(LIBUSB_SOURCE)
	tar -xjf $(MIX_APP_PATH)/$(LIBUSB_SOURCE) -C $(MIX_APP_PATH)
	cd $(LIBUSB_BUILD) && ./configure --disable-udev --prefix=$(PREFIX) $(LIBUSB_CONFIGURE_ARGS)
	cd $(LIBUSB_BUILD) && $(MAKE) install

$(MIX_APP_PATH)/$(LIBUSB_SOURCE):
	wget -O $(MIX_APP_PATH)/$(LIBUSB_SOURCE) $(LIBUSB_SITE)/$(LIBUSB_SOURCE)

$(LIBFREENECT): $(MIX_APP_PATH)/$(LIBFREENECT_SOURCE)
	tar -xf $(MIX_APP_PATH)/$(LIBFREENECT_SOURCE) -C $(MIX_APP_PATH)
	cd $(LIBFREENECT_BUILD) && mkdir build
	cd $(LIBFREENECT_BUILD)/build && cmake .. -DCMAKE_PREFIX_PATH=$(PREFIX)/lib -DCMAKE_INSTALL_PREFIX=$(PREFIX) -DPROJECT_INCLUDE_INSTALL_DIR=$(PREFIX)/include $(LIBFREENECT_CMAKE_FLAGS)
	cd $(LIBFREENECT_BUILD)/build && $(MAKE) install

$(MIX_APP_PATH)/$(LIBFREENECT_SOURCE):
	wget -O $(MIX_APP_PATH)/$(LIBFREENECT_SOURCE) $(LIBFREENECT_SITE)

$(LIBJPEG_TURBO): $(MIX_APP_PATH)/$(LIBJPEG_TURBO_SOURCE)
	tar -xf $(MIX_APP_PATH)/$(LIBJPEG_TURBO_SOURCE) -C $(MIX_APP_PATH)
	cd $(LIBJPEG_TURBO_BUILD) && mkdir build
	cd $(LIBJPEG_TURBO_BUILD)/build && cmake .. -DCMAKE_INSTALL_PREFIX=$(PREFIX) -DPROJECT_INCLUDE_INSTALL_DIR=$(PREFIX)/include
	cd $(LIBJPEG_TURBO_BUILD)/build && $(MAKE) install

$(MIX_APP_PATH)/$(LIBJPEG_TURBO_SOURCE):
	wget -O $(MIX_APP_PATH)/$(LIBJPEG_TURBO_SOURCE) $(LIBJPEG_TURBO_SITE)/$(LIBJPEG_TURBO_SOURCE)

clean:
	rm -rf $(PREFIX)

$(PREFIX) $(BUILD):
	mkdir -p $(PREFIX) $(BUILD)

.PHONY: all clean